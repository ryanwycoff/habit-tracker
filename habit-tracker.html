<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0;
            background: #ffffff;
            padding: 0;
        }

        button {
            background: #000000;
            color: #ffffff;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        button:active {
            background: #333333;
            transform: scale(0.97);
        }

        /* Up Next & Overdue Sections */
        .today-overview {
            background: #ffffff;
            border-bottom: 1px solid #e5e5e5;
        }

        .overview-section {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
        }

        .overview-section:last-child {
            border-bottom: 1px solid #e5e5e5;
        }

        .overview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .overview-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #000000;
        }

        .overview-count {
            font-size: 0.9em;
            font-weight: 600;
            color: #666666;
            background: #f5f5f5;
            padding: 4px 10px;
            border-radius: 12px;
        }

        .overview-list {
            display: grid;
            gap: 8px;
        }

        .overview-item {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 3px solid #000000;
        }

        .overview-item.overdue {
            border-left-color: #000000;
            background: #fafafa;
        }

        .overview-time {
            font-size: 0.85em;
            font-weight: 700;
            color: #000000;
            min-width: 70px;
        }

        .overview-habit {
            font-size: 0.95em;
            color: #000000;
            flex: 1;
            line-height: 1.3;
        }

        .overview-empty {
            text-align: center;
            color: #999999;
            font-size: 0.9em;
            padding: 20px;
        }

        .overview-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #000000;
            flex-shrink: 0;
        }

        /* Calendar Container with Control Panel */
        .calendar-container {
            position: relative;
            background: #ffffff;
            border-bottom: 1px solid #e5e5e5;
        }

        .calendar-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #f5f5f5;
            border-bottom: 1px solid #e5e5e5;
            gap: 8px;
        }

        .year-selector,
        .month-selector {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e5e5e5;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            background: #ffffff;
            color: #000000;
            cursor: pointer;
        }

        .year-selector:focus,
        .month-selector:focus {
            outline: none;
            border-color: #000000;
        }

        .btn-today {
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 6px;
            background: #000000;
            color: #ffffff;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .btn-today:active {
            background: #333333;
        }

        /* Calendar */
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            padding: 12px;
            background: #ffffff;
        }

        .day-header {
            text-align: center;
            font-weight: 600;
            padding: 12px 4px;
            background: #f5f5f5;
            border-radius: 6px;
            color: #000000;
            font-size: 0.85em;
        }

        .day-cell {
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            padding: 8px 4px;
            min-height: 70px;
            cursor: pointer;
            background: #ffffff;
            position: relative;
            touch-action: manipulation;
        }

        .day-cell:active {
            background: #f5f5f5;
        }

        .day-cell.empty {
            background: #fafafa;
            border-color: #f0f0f0;
            cursor: default;
        }

        .day-cell.empty:active {
            background: #fafafa;
        }

        .day-cell.today {
            border-color: #666666;
            border-width: 3px;
            background: #f9f9f9;
        }

        .day-cell.selected {
            border-color: #000000;
            background: #f5f5f5;
            border-width: 2px;
        }

        .day-cell.today.selected {
            border-color: #000000;
            border-width: 3px;
        }

        .day-number {
            font-weight: 700;
            font-size: 1em;
            color: #000000;
            margin-bottom: 6px;
            text-align: center;
        }

        .day-cell.today .day-number {
            background: #666666;
            color: #ffffff;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin: 0 auto 6px auto;
        }

        .completion-indicator {
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 6px;
        }

        .completion-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #d0d0d0;
        }

        .completion-dot.completed {
            background: #000000;
        }

        .completion-dot.overdue {
            background: #dc3545;
        }

        /* Daily Schedule Section */
        .daily-schedule-section {
            background: #ffffff;
            padding: 20px 16px;
            margin-bottom: 80px;
        }

        .daily-schedule-header {
            margin-bottom: 20px;
        }

        .selected-date-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #000000;
            margin-bottom: 8px;
        }

        .schedule-day-name {
            font-size: 1em;
            color: #666666;
            font-weight: 500;
        }

        .schedule-list {
            display: grid;
            gap: 12px;
        }

        .schedule-habit-item {
            background: #ffffff;
            border-radius: 12px;
            padding: 16px;
            border: 2px solid #e5e5e5;
        }

        .schedule-habit-item:active {
            background: #fafafa;
        }

        .schedule-habit-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .schedule-habit-time {
            font-size: 0.9em;
            font-weight: 700;
            color: #000000;
            min-width: 75px;
        }

        .schedule-habit-checkbox {
            width: 28px;
            height: 28px;
            cursor: pointer;
            accent-color: #000000;
            flex-shrink: 0;
        }

        .schedule-habit-name {
            font-weight: 600;
            font-size: 1em;
            color: #000000;
            flex: 1;
            line-height: 1.3;
        }

        .schedule-habit-category {
            background: #000000;
            color: #ffffff;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            white-space: nowrap;
        }

        .schedule-habit-notes {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
            font-size: 15px;
            background: #fafafa;
        }

        .schedule-habit-notes:focus {
            outline: none;
            border-color: #000000;
            background: #ffffff;
        }

        .schedule-habit-item.completed {
            opacity: 0.5;
        }

        .schedule-empty {
            text-align: center;
            color: #999999;
            padding: 40px 20px;
            font-size: 0.95em;
        }

        /* Habit Panel */
        .habit-panel {
            background: #ffffff;
            padding: 16px;
            margin-bottom: 80px;
        }

        .habit-panel h2 {
            color: #000000;
            margin-bottom: 16px;
            font-size: 1.5em;
            font-weight: 700;
            padding-left: 4px;
        }

        .selected-date {
            font-size: 1.1em;
            color: #000000;
            margin-bottom: 16px;
            font-weight: 600;
            padding-left: 4px;
        }

        /* Management Menu */
        .management-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #ffffff;
            border-top: 2px solid #e5e5e5;
            padding: 12px 16px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            display: flex;
            gap: 8px;
            z-index: 50;
        }

        .management-menu button {
            flex: 1;
            padding: 12px 8px;
            font-size: 13px;
            background: #f5f5f5;
            color: #000000;
            border: 1px solid #e5e5e5;
        }

        .management-menu button:active {
            background: #e5e5e5;
        }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ffffff;
            z-index: 200;
            display: none;
            overflow-y: auto;
        }

        .settings-panel.active {
            display: block;
        }

        .settings-header {
            position: sticky;
            top: 0;
            background: #ffffff;
            border-bottom: 1px solid #e5e5e5;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .settings-header h2 {
            font-size: 1.5em;
            font-weight: 700;
            color: #000000;
        }

        .settings-content {
            padding: 16px;
            padding-bottom: 100px;
        }

        .settings-section {
            margin-bottom: 32px;
        }

        .settings-section h3 {
            font-size: 1.2em;
            font-weight: 600;
            color: #000000;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e5e5;
        }

        /* Habit Editor */
        .habit-editor-list {
            display: grid;
            gap: 12px;
        }

        .habit-edit-item {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 14px;
            border: 2px solid #e5e5e5;
        }

        .habit-edit-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .habit-edit-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            font-size: 15px;
            background: #ffffff;
        }

        .habit-edit-input:focus {
            outline: none;
            border-color: #000000;
        }

        .habit-edit-category {
            padding: 10px;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            font-size: 14px;
            background: #ffffff;
        }

        .btn-delete-habit {
            background: #000000;
            color: #ffffff;
            padding: 8px 12px;
            font-size: 13px;
            border-radius: 6px;
        }

        .btn-add-habit {
            width: 100%;
            padding: 14px;
            background: #000000;
            color: #ffffff;
            margin-top: 12px;
        }

        /* Schedule Editor */
        .schedule-editor {
            display: grid;
            gap: 12px;
        }

        .schedule-edit-item {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 12px;
            border: 2px solid #e5e5e5;
        }

        .schedule-edit-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .time-input {
            width: 90px;
            padding: 8px;
            border: 2px solid #e5e5e5;
            border-radius: 6px;
            font-size: 14px;
            background: #ffffff;
            font-weight: 600;
        }

        .habit-input {
            flex: 1;
            padding: 8px;
            border: 2px solid #e5e5e5;
            border-radius: 6px;
            font-size: 14px;
            background: #ffffff;
        }

        .btn-delete-schedule {
            background: #000000;
            color: #ffffff;
            padding: 6px 10px;
            font-size: 12px;
            border-radius: 6px;
            white-space: nowrap;
        }

        .btn-add-schedule {
            width: 100%;
            padding: 10px;
            background: #000000;
            color: #ffffff;
            font-size: 13px;
            margin-top: 8px;
        }

        .day-selector {
            margin-bottom: 16px;
        }

        .day-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            font-size: 15px;
            background: #ffffff;
            font-weight: 600;
        }

        /* Data Management */
        .data-actions {
            display: grid;
            gap: 12px;
        }

        .data-action-item {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 16px;
            border: 2px solid #e5e5e5;
        }

        .data-action-item h4 {
            font-size: 1.1em;
            font-weight: 600;
            color: #000000;
            margin-bottom: 8px;
        }

        .data-action-item p {
            font-size: 0.9em;
            color: #666666;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .data-action-item button {
            width: 100%;
        }

        /* Category Management */
        .category-list {
            display: grid;
            gap: 12px;
        }

        .category-item {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 14px;
            border: 2px solid #e5e5e5;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            font-size: 15px;
            background: #ffffff;
            font-weight: 600;
        }

        .category-input:focus {
            outline: none;
            border-color: #000000;
        }

        .category-badge {
            background: #000000;
            color: #ffffff;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
        }

        .category-usage {
            font-size: 12px;
            color: #666666;
            white-space: nowrap;
        }

        .btn-delete-category {
            background: #000000;
            color: #ffffff;
            padding: 8px 12px;
            font-size: 13px;
            border-radius: 6px;
            white-space: nowrap;
        }

        .btn-add-category {
            width: 100%;
            padding: 14px;
            background: #000000;
            color: #ffffff;
            margin-top: 12px;
        }

        .category-warning {
            background: #f5f5f5;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            font-size: 13px;
            color: #666666;
            line-height: 1.4;
        }

        /* Close button */
        .btn-close {
            background: #f5f5f5;
            color: #000000;
            padding: 8px 16px;
            border: 1px solid #e5e5e5;
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .view-toggle button {
            flex: 1;
            padding: 14px;
            background: #f5f5f5;
            color: #000000;
            border: 2px solid #e5e5e5;
            font-size: 14px;
        }

        .view-toggle button.active {
            background: #000000;
            color: #ffffff;
            border-color: #000000;
        }

        .view-toggle button:active {
            transform: scale(0.98);
        }

        /* Schedule View */
        .schedule-view {
            display: none;
        }

        .schedule-view.active {
            display: block;
        }

        .schedule-timeline {
            position: relative;
            padding-left: 80px;
        }

        .schedule-item {
            position: relative;
            margin-bottom: 12px;
            padding: 14px;
            background: #ffffff;
            border-radius: 10px;
            border: 2px solid #e5e5e5;
            border-left: 4px solid #000000;
        }

        .schedule-time {
            position: absolute;
            left: -80px;
            top: 14px;
            font-weight: 700;
            color: #000000;
            font-size: 0.9em;
            width: 70px;
            text-align: right;
        }

        .schedule-habit {
            font-size: 0.95em;
            color: #000000;
            line-height: 1.4;
        }

        .schedule-item.completed {
            opacity: 0.4;
            border-left-color: #666666;
        }

        .schedule-item.completed .schedule-time {
            color: #666666;
        }

        /* Habit List */
        .habit-list {
            display: grid;
            gap: 12px;
        }

        .habit-item {
            background: #ffffff;
            border-radius: 12px;
            padding: 16px;
            border: 2px solid #e5e5e5;
        }

        .habit-item:active {
            background: #fafafa;
        }

        .habit-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .habit-checkbox {
            width: 28px;
            height: 28px;
            cursor: pointer;
            accent-color: #000000;
            flex-shrink: 0;
        }

        .habit-name {
            font-weight: 600;
            font-size: 1em;
            color: #000000;
            flex: 1;
            line-height: 1.3;
        }

        .habit-category {
            background: #000000;
            color: #ffffff;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            white-space: nowrap;
        }

        .habit-notes {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
            font-size: 15px;
            background: #fafafa;
        }

        .habit-notes:focus {
            outline: none;
            border-color: #000000;
            background: #ffffff;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #ffffff;
            padding: 24px;
            border-radius: 16px;
            max-width: 400px;
            width: 100%;
        }

        .modal-content h3 {
            color: #000000;
            margin-bottom: 16px;
            font-size: 1.3em;
        }

        .modal-content p {
            color: #333333;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-buttons button {
            min-width: 80px;
        }

        .file-input {
            display: none;
        }

        /* Safe area for iPhone */
        @supports (padding: max(0px)) {
            body {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* iPhone specific optimizations */
        @media (max-width: 428px) {
            h1 {
                font-size: 1.5em;
                padding: 16px 12px 10px 12px;
            }

            .stats-bar {
                padding: 12px;
            }

            .stat-value {
                font-size: 1.3em;
            }

            .stat-label {
                font-size: 0.7em;
            }

            .calendar {
                padding: 8px;
                gap: 3px;
            }

            .day-cell {
                min-height: 60px;
                padding: 6px 2px;
            }

            .day-number {
                font-size: 0.9em;
            }

            .completion-dot {
                width: 5px;
                height: 5px;
            }

            .schedule-timeline {
                padding-left: 70px;
            }

            .schedule-time {
                left: -70px;
                width: 60px;
                font-size: 0.8em;
            }

            .schedule-habit {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 1. Overdue Section -->
        <div class="today-overview">
            <div class="overview-section" id="overdueSection" style="display: none;">
                <div class="overview-header">
                    <div class="overview-title">‚ö†Ô∏è Overdue</div>
                    <div class="overview-count" id="overdueCount">0</div>
                </div>
                <div class="overview-list" id="overdueList"></div>
            </div>

            <!-- 2. Up Next Section -->
            <div class="overview-section" id="upNextSection">
                <div class="overview-header">
                    <div class="overview-title">Up Next</div>
                    <div class="overview-count" id="upNextCount">0</div>
                </div>
                <div class="overview-list" id="upNextList"></div>
            </div>
        </div>

        <!-- 3. Calendar with Control Panel -->
        <div class="calendar-container">
            <div class="calendar-controls">
                <select class="year-selector" id="yearSelector" onchange="updateCalendarMonth()"></select>
                <select class="month-selector" id="monthSelector" onchange="updateCalendarMonth()"></select>
                <button class="btn-today" onclick="selectToday()">Today</button>
            </div>
            <div class="calendar" id="calendar"></div>
        </div>

        <!-- 4. Daily Schedule with Full Habit Functionality -->
        <div class="daily-schedule-section" id="dailyScheduleSection">
            <div class="daily-schedule-header">
                <div class="selected-date-title" id="selectedDateTitle">Select a date</div>
                <div class="schedule-day-name" id="scheduleDayName"></div>
            </div>
            <div class="schedule-list" id="scheduleList"></div>
        </div>

        <div class="management-menu">
            <button onclick="openSettings()">Manage</button>
            <button onclick="exportData()">Export</button>
            <button onclick="document.getElementById('importFile').click()">Import</button>
        </div>

        <div class="settings-panel" id="settingsPanel">
            <div class="settings-header">
                <h2>Manage Data</h2>
                <button class="btn-close" onclick="closeSettings()">Done</button>
            </div>
            <div class="settings-content">
                
                <!-- Category Management -->
                <div class="settings-section">
                    <h3>Manage Categories</h3>
                    <div class="category-list" id="categoryList"></div>
                    <button class="btn-add-category" onclick="addNewCategory()">+ Add New Category</button>
                    <div class="category-warning">
                        üí° Categories help organize your habits. Renaming a category updates all habits using it. Deleting a category will change affected habits to "Uncategorized".
                    </div>
                </div>

                <!-- Habit Editor -->
                <div class="settings-section">
                    <h3>Edit Habits</h3>
                    <div class="habit-editor-list" id="habitEditorList"></div>
                    <button class="btn-add-habit" onclick="addNewHabit()">+ Add New Habit</button>
                </div>

                <!-- Schedule Editor -->
                <div class="settings-section">
                    <h3>Edit Schedule</h3>
                    <div class="day-selector">
                        <select id="scheduleEditDay" onchange="renderScheduleEditor()">
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                            <option value="Saturday">Saturday</option>
                            <option value="Sunday">Sunday</option>
                        </select>
                    </div>
                    <div class="schedule-editor" id="scheduleEditorList"></div>
                    <button class="btn-add-schedule" onclick="addNewScheduleItem()">+ Add Schedule Item</button>
                </div>

                <!-- Data Management -->
                <div class="settings-section">
                    <h3>Data Management</h3>
                    <div class="data-actions">
                        <div class="data-action-item">
                            <h4>View All Data</h4>
                            <p>See all your tracked habits and notes in JSON format</p>
                            <button onclick="viewAllData()">View Data</button>
                        </div>
                        <div class="data-action-item">
                            <h4>Export Backup</h4>
                            <p>Download all your data as a JSON file to your device</p>
                            <button onclick="exportData()">Export Data</button>
                        </div>
                        <div class="data-action-item">
                            <h4>Import Backup</h4>
                            <p>Restore data from a previously exported file</p>
                            <button onclick="document.getElementById('importFile').click()">Import Data</button>
                        </div>
                        <div class="data-action-item">
                            <h4>Clear All Data</h4>
                            <p>Permanently delete all tracked habits and notes</p>
                            <button onclick="confirmClear()">Clear All Data</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="modal" id="clearModal">
        <div class="modal-content">
            <h3>Clear All Data?</h3>
            <p>This will permanently delete all your tracked habits and notes. This action cannot be undone.</p>
            <div class="modal-buttons">
                <button onclick="closeModal()">Cancel</button>
                <button class="btn-clear" onclick="clearAllData()">Yes, Clear All</button>
            </div>
        </div>
    </div>

    <div class="modal" id="dataViewModal">
        <div class="modal-content" style="max-width: 90%; max-height: 80vh; overflow-y: auto;">
            <h3>All Saved Data</h3>
            <pre id="dataViewContent" style="background: #f5f5f5; padding: 16px; border-radius: 8px; font-size: 12px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"></pre>
            <div class="modal-buttons">
                <button onclick="closeDataView()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Global categories array
        let categories = ['Climbing', 'Fitness', 'Recreation', 'Grooming', 'Nutrition', 'Supplements'];

        const scheduleByDay = {
            'Monday': [
                { time: '4:30 AM', habit: 'Wake Up & Hydrate' },
                { time: '4:40 AM', habit: 'Dead Hang (3 sets)' },
                { time: '4:50 AM', habit: 'Beard Oil + Microneedling' },
                { time: '5:00 AM', habit: 'Pre-Workout Supplements' },
                { time: '5:05 AM', habit: 'Workout: Upper Body & Climbing (80 min)' },
                { time: '6:25 AM', habit: 'Shower & Hair Styling' },
                { time: '6:45 AM', habit: 'Meal 1: Eggs & Oats + Morning Supplements' },
                { time: '7:00 AM', habit: 'Leave for Work (1 hour commute)' },
                { time: '8:00 AM', habit: 'Arrive at Work' },
                { time: '11:30 AM', habit: 'Meal 2: Chicken & Greens' },
                { time: '2:30 PM', habit: 'Meal 3: Turkey & Broccoli' },
                { time: '5:00 PM', habit: 'Leave Work (1 hour commute)' },
                { time: '6:00 PM', habit: 'Arrive Home' },
                { time: '6:15 PM', habit: 'Meal 4: Protein Shake' },
                { time: '6:45 PM', habit: 'Evening Relax/Activity' },
                { time: '8:00 PM', habit: 'Meal 5: Salmon & Asparagus' },
                { time: '9:00 PM', habit: 'Evening Supplements + Beard Oil' },
                { time: '9:30 PM', habit: 'Bed' }
            ],
            'Tuesday': [
                { time: '4:30 AM', habit: 'Wake Up & Hydrate' },
                { time: '4:40 AM', habit: 'Dead Hang (3 sets)' },
                { time: '4:50 AM', habit: 'Beard Oil Application' },
                { time: '5:00 AM', habit: 'Pre-Workout Supplements' },
                { time: '5:05 AM', habit: 'Workout: Legs & Grip (70 min)' },
                { time: '6:15 AM', habit: 'Shower & Hair Styling' },
                { time: '6:40 AM', habit: 'Meal 1: Eggs & Oats + Morning Supplements' },
                { time: '7:00 AM', habit: 'Leave for Work (1 hour commute)' },
                { time: '8:00 AM', habit: 'Arrive at Work' },
                { time: '11:30 AM', habit: 'Meal 2: Chicken & Greens' },
                { time: '2:30 PM', habit: 'Meal 3: Turkey & Broccoli' },
                { time: '5:00 PM', habit: 'Leave Work (1 hour commute)' },
                { time: '6:00 PM', habit: 'Arrive Home' },
                { time: '6:15 PM', habit: 'Meal 4: Protein Shake' },
                { time: '6:30 PM', habit: 'Manscaping: Chest & Stomach' },
                { time: '7:00 PM', habit: 'Golf Simulator (60 min)' },
                { time: '8:15 PM', habit: 'Meal 5: Salmon & Vegetables' },
                { time: '9:00 PM', habit: 'Evening Supplements + Beard Oil' },
                { time: '9:30 PM', habit: 'Bed' }
            ],
            'Wednesday': [
                { time: '4:30 AM', habit: 'Wake Up & Hydrate' },
                { time: '4:40 AM', habit: 'Dead Hang (3 sets)' },
                { time: '4:50 AM', habit: 'Beard Oil Application' },
                { time: '5:00 AM', habit: 'Yoga Session (60 min)' },
                { time: '6:00 AM', habit: 'Shower & Hair Styling' },
                { time: '6:35 AM', habit: 'Meal 1: Eggs & Oats + Morning Supplements' },
                { time: '7:00 AM', habit: 'Leave for Work (1 hour commute)' },
                { time: '8:00 AM', habit: 'Arrive at Work' },
                { time: '11:30 AM', habit: 'Meal 2: Chicken & Greens' },
                { time: '2:30 PM', habit: 'Meal 3: Turkey & Vegetables' },
                { time: '5:00 PM', habit: 'Leave Work (1 hour commute)' },
                { time: '6:00 PM', habit: 'Arrive Home' },
                { time: '6:15 PM', habit: 'Meal 4: Protein Shake' },
                { time: '6:30 PM', habit: 'Manscaping: Back & Shoulders (every 2 weeks)' },
                { time: '7:15 PM', habit: 'Light Walk (30 min)' },
                { time: '8:00 PM', habit: 'Meal 5: Fish & Vegetables' },
                { time: '8:30 PM', habit: 'Foam Rolling & Stretching' },
                { time: '9:00 PM', habit: 'Evening Supplements + Beard Oil' },
                { time: '9:30 PM', habit: 'Bed' }
            ],
            'Thursday': [
                { time: '4:30 AM', habit: 'Wake Up & Hydrate' },
                { time: '4:40 AM', habit: 'Dead Hang (3 sets)' },
                { time: '4:50 AM', habit: 'Beard Oil Application' },
                { time: '5:00 AM', habit: 'Pre-Workout Supplements' },
                { time: '5:05 AM', habit: 'Workout: Climbing & Full Body (80 min)' },
                { time: '6:25 AM', habit: 'Shower & Hair Styling' },
                { time: '6:45 AM', habit: 'Meal 1: Eggs & Oats + Morning Supplements' },
                { time: '7:00 AM', habit: 'Leave for Work (1 hour commute)' },
                { time: '8:00 AM', habit: 'Arrive at Work' },
                { time: '11:30 AM', habit: 'Meal 2: Chicken & Greens' },
                { time: '2:30 PM', habit: 'Meal 3: Turkey & Broccoli' },
                { time: '5:00 PM', habit: 'Leave Work (1 hour commute)' },
                { time: '6:00 PM', habit: 'Arrive Home' },
                { time: '6:15 PM', habit: 'Meal 4: Protein Shake' },
                { time: '6:45 PM', habit: 'Evening Relax/Hobby' },
                { time: '8:00 PM', habit: 'Meal 5: Salmon & Vegetables' },
                { time: '9:00 PM', habit: 'Evening Supplements + Beard Oil' },
                { time: '9:30 PM', habit: 'Bed' }
            ],
            'Friday': [
                { time: '4:30 AM', habit: 'Wake Up & Hydrate' },
                { time: '4:40 AM', habit: 'Dead Hang (3 sets)' },
                { time: '4:50 AM', habit: 'Beard Oil Application' },
                { time: '5:00 AM', habit: 'Pre-Workout Supplements' },
                { time: '5:05 AM', habit: 'Workout: Lower Body & Grip (70 min)' },
                { time: '6:15 AM', habit: 'Shower & Hair Styling' },
                { time: '6:40 AM', habit: 'Meal 1: Eggs & Oats + Morning Supplements' },
                { time: '7:00 AM', habit: 'Leave for Work (1 hour commute)' },
                { time: '8:00 AM', habit: 'Arrive at Work' },
                { time: '11:30 AM', habit: 'Meal 2: Chicken & Greens' },
                { time: '2:30 PM', habit: 'Meal 3: Turkey & Vegetables' },
                { time: '5:00 PM', habit: 'Leave Work (1 hour commute)' },
                { time: '6:00 PM', habit: 'Arrive Home' },
                { time: '6:15 PM', habit: 'Meal 4: Protein Shake' },
                { time: '6:30 PM', habit: 'Manscaping: Genitals, Butt & Legs' },
                { time: '7:15 PM', habit: 'Golf Simulator (60 min)' },
                { time: '8:30 PM', habit: 'Meal 5: Chicken & Vegetables (Refeed)' },
                { time: '9:00 PM', habit: 'Evening Supplements + Beard Oil' },
                { time: '10:00 PM', habit: 'Bed' }
            ],
            'Saturday': [
                { time: '6:30 AM', habit: 'Wake Up & Hydrate' },
                { time: '6:45 AM', habit: 'Dead Hang (3 sets)' },
                { time: '6:55 AM', habit: 'Beard Oil + Microneedling' },
                { time: '7:10 AM', habit: 'Meal 1: Eggs & Oats + Morning Supplements' },
                { time: '8:00 AM', habit: 'Workout: Upper Body (70 min)' },
                { time: '9:10 AM', habit: 'Shower & Hair Styling' },
                { time: '10:00 AM', habit: 'Meal 2: Protein-rich Brunch' },
                { time: '10:30 AM', habit: 'Errands/Activities' },
                { time: '1:30 PM', habit: 'Meal 3: Lunch' },
                { time: '2:30 PM', habit: 'Manscaping: Arms (every 2 weeks)' },
                { time: '3:00 PM', habit: 'Free Time' },
                { time: '5:00 PM', habit: 'Yoga Session (60 min)' },
                { time: '6:30 PM', habit: 'Meal 4: Dinner' },
                { time: '8:00 PM', habit: 'Meal 5: Light Evening Meal' },
                { time: '9:00 PM', habit: 'Evening Supplements + Beard Oil' },
                { time: '10:30 PM', habit: 'Bed' }
            ],
            'Sunday': [
                { time: '7:00 AM', habit: 'Wake Up & Hydrate' },
                { time: '7:15 AM', habit: 'Dead Hang (3 sets)' },
                { time: '7:25 AM', habit: 'Beard Oil Application' },
                { time: '7:30 AM', habit: 'Meal 1: Protein Breakfast + Supplements' },
                { time: '8:30 AM', habit: 'Light Walk or Bike (45 min)' },
                { time: '9:30 AM', habit: 'Shower & Full Grooming Session' },
                { time: '10:30 AM', habit: 'Meal 2: Brunch' },
                { time: '11:30 AM', habit: 'Stretching & Mobility Work' },
                { time: '12:30 PM', habit: 'Meal Prep for Week (2 hours)' },
                { time: '2:30 PM', habit: 'Golf Simulator (90 min)' },
                { time: '4:30 PM', habit: 'Meal 3: Afternoon Meal' },
                { time: '5:30 PM', habit: 'Relax/Entertainment' },
                { time: '7:00 PM', habit: 'Meal 4: Dinner' },
                { time: '8:30 PM', habit: 'Evening Supplements + Beard Oil' },
                { time: '9:30 PM', habit: 'Bed' }
            ]
        };

        const habits = [
            { id: 'deadhang', name: 'Dead Hang (3 sets to failure)', category: 'Climbing', schedule: true },
            { id: 'workout', name: 'Workout Complete', category: 'Fitness', schedule: true },
            { id: 'climbing', name: 'Climbing Training', category: 'Climbing', schedule: true },
            { id: 'golf', name: 'Golf Simulator', category: 'Recreation', schedule: true },
            { id: 'yoga', name: 'Yoga Session', category: 'Fitness', schedule: true },
            { id: 'beardoil', name: 'Beard Oil Application', category: 'Grooming', schedule: true },
            { id: 'microneedling', name: 'Microneedling Session', category: 'Grooming', schedule: true },
            { id: 'hairstyle', name: 'Hair Styling', category: 'Grooming', schedule: true },
            { id: 'manscaping', name: 'Manscaping (Scheduled Area)', category: 'Grooming', schedule: true },
            { id: 'meal1', name: 'Meal 1 - Breakfast', category: 'Nutrition', schedule: true },
            { id: 'meal2', name: 'Meal 2 - Mid-Morning/Lunch', category: 'Nutrition', schedule: true },
            { id: 'meal3', name: 'Meal 3 - Afternoon', category: 'Nutrition', schedule: true },
            { id: 'meal4', name: 'Meal 4 - Post-Work', category: 'Nutrition', schedule: true },
            { id: 'meal5', name: 'Meal 5 - Dinner', category: 'Nutrition', schedule: true },
            { id: 'supplements_am', name: 'Morning Supplements', category: 'Supplements', schedule: true },
            { id: 'supplements_pre', name: 'Pre-Workout Supplements', category: 'Supplements', schedule: true },
            { id: 'supplements_post', name: 'Post-Workout Supplements', category: 'Supplements', schedule: true },
            { id: 'supplements_pm', name: 'Evening Supplements', category: 'Supplements', schedule: true },
            { id: 'wakeup', name: 'Wake Up & Hydrate', category: 'Fitness', schedule: true },
            { id: 'shower', name: 'Shower', category: 'Grooming', schedule: true },
            { id: 'commute_work', name: 'Commute to Work', category: 'Recreation', schedule: true },
            { id: 'commute_home', name: 'Commute Home', category: 'Recreation', schedule: true },
            { id: 'relax', name: 'Relax/Free Time', category: 'Recreation', schedule: true },
            { id: 'walk', name: 'Light Walk/Activity', category: 'Fitness', schedule: true },
            { id: 'stretching', name: 'Stretching & Mobility', category: 'Fitness', schedule: true },
            { id: 'foam_rolling', name: 'Foam Rolling', category: 'Fitness', schedule: true },
            { id: 'errands', name: 'Errands/Shopping', category: 'Recreation', schedule: true },
            { id: 'meal_prep', name: 'Meal Prep', category: 'Nutrition', schedule: true },
            { id: 'grooming_full', name: 'Full Grooming Session', category: 'Grooming', schedule: true },
            { id: 'bed', name: 'Bedtime', category: 'Fitness', schedule: true },
        ];

        let currentDate = new Date();
        let selectedDate = null;

        function initializeCalendarControls() {
            const yearSelector = document.getElementById('yearSelector');
            const monthSelector = document.getElementById('monthSelector');
            
            // Populate year selector (current year ¬± 2 years)
            const currentYear = new Date().getFullYear();
            for (let year = currentYear - 2; year <= currentYear + 2; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelector.appendChild(option);
            }
            
            // Populate month selector
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                monthSelector.appendChild(option);
            });
            
            // Set to current month/year
            yearSelector.value = currentDate.getFullYear();
            monthSelector.value = currentDate.getMonth();
        }

        function updateCalendarMonth() {
            const yearSelector = document.getElementById('yearSelector');
            const monthSelector = document.getElementById('monthSelector');
            
            const selectedYear = parseInt(yearSelector.value);
            const selectedMonth = parseInt(monthSelector.value);
            
            currentDate = new Date(selectedYear, selectedMonth, 1);
            renderCalendar();
        }

        function selectToday() {
            const today = new Date();
            selectedDate = today.toISOString().split('T')[0];
            
            // Update current date to today's month/year
            currentDate = new Date(today.getFullYear(), today.getMonth(), 1);
            
            // Update selectors
            document.getElementById('yearSelector').value = today.getFullYear();
            document.getElementById('monthSelector').value = today.getMonth();
            
            renderCalendar();
            renderDailySchedule();
        }

        function autoCompletePastDates() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Go back 90 days to auto-complete (about 3 months)
            const startDate = new Date(today);
            startDate.setDate(startDate.getDate() - 90);
            
            let currentCheckDate = new Date(startDate);
            
            while (currentCheckDate < today) {
                const dateStr = currentCheckDate.toISOString().split('T')[0];
                const dayName = currentCheckDate.toLocaleDateString('en-US', { weekday: 'long' });
                const schedule = scheduleByDay[dayName] || [];
                
                // Get existing data for this date
                let data = getData(dateStr);
                
                // Mark all scheduled habits as complete for past dates
                schedule.forEach(item => {
                    const habitId = getHabitIdFromScheduleText(item.habit);
                    if (habitId) {
                        if (!data[habitId]) {
                            data[habitId] = { completed: false, notes: '' };
                        }
                        data[habitId].completed = true;
                    }
                });
                
                // Save the data
                localStorage.setItem(`habit_${dateStr}`, JSON.stringify(data));
                
                // Move to next day
                currentCheckDate.setDate(currentCheckDate.getDate() + 1);
            }
        }

        function initializeTracker() {
            loadCategories();
            loadHabits();
            loadSchedule();
            
            // Initialize calendar controls
            initializeCalendarControls();
            
            // Auto-complete all past dates on first load
            const hasInitialized = localStorage.getItem('tracker_initialized');
            if (!hasInitialized) {
                autoCompletePastDates();
                localStorage.setItem('tracker_initialized', 'true');
            }
            
            // Select today's date by default
            const today = new Date();
            selectedDate = today.toISOString().split('T')[0];
            
            renderCalendar();
            renderDailySchedule();
            updateStats();
            updateTodayOverview();
        }

        function updateTodayOverview() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const todayStr = today.toISOString().split('T')[0];
            const dayName = today.toLocaleDateString('en-US', { weekday: 'long' });
            
            // Get today's schedule
            const schedule = scheduleByDay[dayName] || [];
            const data = getData(todayStr);
            
            // Parse current time
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            // Find overdue and upcoming items
            const overdue = [];
            const upNext = [];
            
            schedule.forEach((item, index) => {
                const itemMinutes = parseTimeToMinutes(item.time);
                
                if (itemMinutes === null) return;
                
                const isCompleted = isScheduleItemCompleted(item.habit, data);
                
                if (!isCompleted && itemMinutes < currentMinutes) {
                    // Overdue - store with time difference for sorting
                    overdue.push({ 
                        ...item, 
                        index,
                        minutesLate: currentMinutes - itemMinutes 
                    });
                } else if (!isCompleted && itemMinutes >= currentMinutes) {
                    // Upcoming
                    if (upNext.length < 3) {
                        upNext.push({ ...item, index });
                    }
                }
            });
            
            // Sort overdue by most late first (descending minutes late)
            overdue.sort((a, b) => b.minutesLate - a.minutesLate);
            
            // Limit to top 3 most late items
            const displayedOverdue = overdue.slice(0, 3);
            const remainingOverdue = overdue.length - displayedOverdue.length;
            
            // Render overdue section
            const overdueSection = document.getElementById('overdueSection');
            const overdueList = document.getElementById('overdueList');
            const overdueCount = document.getElementById('overdueCount');
            
            if (overdue.length > 0) {
                overdueSection.style.display = 'block';
                
                // Show total count with "+X more" if needed
                if (remainingOverdue > 0) {
                    overdueCount.textContent = `${displayedOverdue.length} (+${remainingOverdue} more)`;
                } else {
                    overdueCount.textContent = overdue.length;
                }
                
                overdueList.innerHTML = '';
                
                displayedOverdue.forEach(item => {
                    const el = createOverviewItem(item, todayStr, true);
                    overdueList.appendChild(el);
                });
            } else {
                overdueSection.style.display = 'none';
            }
            
            // Render up next section
            const upNextList = document.getElementById('upNextList');
            const upNextCount = document.getElementById('upNextCount');
            
            if (upNext.length > 0) {
                upNextCount.textContent = upNext.length;
                upNextList.innerHTML = '';
                
                upNext.forEach(item => {
                    const el = createOverviewItem(item, todayStr, false);
                    upNextList.appendChild(el);
                });
            } else {
                upNextList.innerHTML = '<div class="overview-empty">All caught up! üéâ</div>';
                upNextCount.textContent = '0';
            }
        }

        function parseTimeToMinutes(timeStr) {
            // Parse "8:00 AM" or "12:30 PM" to minutes since midnight
            const match = timeStr.match(/(\d+):(\d+)\s*(AM|PM)/i);
            if (!match) return null;
            
            let hours = parseInt(match[1]);
            const minutes = parseInt(match[2]);
            const period = match[3].toUpperCase();
            
            if (period === 'PM' && hours !== 12) hours += 12;
            if (period === 'AM' && hours === 12) hours = 0;
            
            return hours * 60 + minutes;
        }

        function isScheduleItemCompleted(habitText, data) {
            const habitLower = habitText.toLowerCase();
            
            // Check if any tracked habit is completed
            if (habitLower.includes('wake up') || habitLower.includes('hydrate')) return data['wakeup']?.completed || false;
            if (habitLower.includes('dead hang')) return data['deadhang']?.completed || false;
            if (habitLower.includes('beard oil')) return data['beardoil']?.completed || false;
            if (habitLower.includes('microneedling')) return data['microneedling']?.completed || false;
            if (habitLower.includes('pre-workout supplements')) return data['supplements_pre']?.completed || false;
            if (habitLower.includes('workout') && !habitLower.includes('pre-workout')) return data['workout']?.completed || false;
            if (habitLower.includes('climbing')) return data['climbing']?.completed || false;
            if (habitLower.includes('shower')) return data['shower']?.completed || false;
            if (habitLower.includes('hair styling')) return data['hairstyle']?.completed || false;
            if (habitLower.includes('meal 1')) return data['meal1']?.completed || false;
            if (habitLower.includes('meal 2')) return data['meal2']?.completed || false;
            if (habitLower.includes('meal 3')) return data['meal3']?.completed || false;
            if (habitLower.includes('meal 4')) return data['meal4']?.completed || false;
            if (habitLower.includes('meal 5')) return data['meal5']?.completed || false;
            if (habitLower.includes('morning supplements')) return data['supplements_am']?.completed || false;
            if (habitLower.includes('post-workout')) return data['supplements_post']?.completed || false;
            if (habitLower.includes('evening supplements')) return data['supplements_pm']?.completed || false;
            if (habitLower.includes('leave for work') || (habitLower.includes('commute') && habitLower.includes('work'))) return data['commute_work']?.completed || false;
            if (habitLower.includes('arrive home') || (habitLower.includes('commute') && habitLower.includes('home'))) return data['commute_home']?.completed || false;
            if (habitLower.includes('manscaping')) return data['manscaping']?.completed || false;
            if (habitLower.includes('golf')) return data['golf']?.completed || false;
            if (habitLower.includes('yoga')) return data['yoga']?.completed || false;
            if (habitLower.includes('relax') || habitLower.includes('free time') || habitLower.includes('hobby')) return data['relax']?.completed || false;
            if (habitLower.includes('walk') || habitLower.includes('bike') || habitLower.includes('light')) return data['walk']?.completed || false;
            if (habitLower.includes('stretching') || habitLower.includes('mobility')) return data['stretching']?.completed || false;
            if (habitLower.includes('foam rolling')) return data['foam_rolling']?.completed || false;
            if (habitLower.includes('errands') || habitLower.includes('shopping') || habitLower.includes('activities')) return data['errands']?.completed || false;
            if (habitLower.includes('meal prep')) return data['meal_prep']?.completed || false;
            if (habitLower.includes('full grooming') || habitLower.includes('grooming session')) return data['grooming_full']?.completed || false;
            if (habitLower.includes('bed')) return data['bed']?.completed || false;
            
            return false;
        }

        function createOverviewItem(item, dateStr, isOverdue) {
            const el = document.createElement('div');
            el.className = 'overview-item' + (isOverdue ? ' overdue' : '');
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'overview-checkbox';
            checkbox.checked = false;
            checkbox.onchange = (e) => {
                quickCompleteHabit(item.habit, dateStr);
                updateTodayOverview();
                renderCalendar();
            };
            
            const time = document.createElement('div');
            time.className = 'overview-time';
            time.textContent = item.time;
            
            const habit = document.createElement('div');
            habit.className = 'overview-habit';
            habit.textContent = item.habit;
            
            el.appendChild(checkbox);
            el.appendChild(time);
            el.appendChild(habit);
            
            return el;
        }

        function quickCompleteHabit(habitText, dateStr) {
            const habitLower = habitText.toLowerCase();
            const data = getData(dateStr);
            
            // Helper function to mark habit complete
            const markComplete = (habitId) => {
                if (!data[habitId]) data[habitId] = { completed: false, notes: '' };
                data[habitId].completed = true;
                
                // Live update calendar dot
                updateCalendarDot(dateStr, habitId, true);
            };
            
            // Map schedule text to habit IDs and mark as completed
            if (habitLower.includes('wake up') || habitLower.includes('hydrate')) markComplete('wakeup');
            if (habitLower.includes('dead hang')) markComplete('deadhang');
            if (habitLower.includes('beard oil')) markComplete('beardoil');
            if (habitLower.includes('microneedling')) markComplete('microneedling');
            if (habitLower.includes('pre-workout supplements')) markComplete('supplements_pre');
            if (habitLower.includes('workout') && !habitLower.includes('pre-workout')) markComplete('workout');
            if (habitLower.includes('climbing')) markComplete('climbing');
            if (habitLower.includes('shower')) markComplete('shower');
            if (habitLower.includes('hair styling')) markComplete('hairstyle');
            if (habitLower.includes('meal 1')) markComplete('meal1');
            if (habitLower.includes('meal 2')) markComplete('meal2');
            if (habitLower.includes('meal 3')) markComplete('meal3');
            if (habitLower.includes('meal 4')) markComplete('meal4');
            if (habitLower.includes('meal 5')) markComplete('meal5');
            if (habitLower.includes('morning supplements')) markComplete('supplements_am');
            if (habitLower.includes('post-workout')) markComplete('supplements_post');
            if (habitLower.includes('evening supplements')) markComplete('supplements_pm');
            if (habitLower.includes('leave for work') || (habitLower.includes('commute') && habitLower.includes('work'))) markComplete('commute_work');
            if (habitLower.includes('arrive home') || (habitLower.includes('commute') && habitLower.includes('home'))) markComplete('commute_home');
            if (habitLower.includes('manscaping')) markComplete('manscaping');
            if (habitLower.includes('golf')) markComplete('golf');
            if (habitLower.includes('yoga')) markComplete('yoga');
            if (habitLower.includes('relax') || habitLower.includes('free time') || habitLower.includes('hobby')) markComplete('relax');
            if (habitLower.includes('walk') || habitLower.includes('bike') || habitLower.includes('light')) markComplete('walk');
            if (habitLower.includes('stretching') || habitLower.includes('mobility')) markComplete('stretching');
            if (habitLower.includes('foam rolling')) markComplete('foam_rolling');
            if (habitLower.includes('errands') || habitLower.includes('shopping') || habitLower.includes('activities')) markComplete('errands');
            if (habitLower.includes('meal prep')) markComplete('meal_prep');
            if (habitLower.includes('full grooming') || habitLower.includes('grooming session')) markComplete('grooming_full');
            if (habitLower.includes('bed')) markComplete('bed');
            
            setData(dateStr, data);
            
            // Force update today overview after quick completion
            updateTodayOverview();
        }

        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            
            calendar.innerHTML = '';
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            daysOfWeek.forEach(day => {
                const header = document.createElement('div');
                header.className = 'day-header';
                header.textContent = day;
                calendar.appendChild(header);
            });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'day-cell empty';
                calendar.appendChild(emptyCell);
            }
            
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                
                const dateObj = new Date(year, month, day);
                const dateStr = dateObj.toISOString().split('T')[0];
                
                // Mark today cell
                if (dateObj.toDateString() === today.toDateString()) {
                    cell.classList.add('today');
                }
                
                // Mark selected cell
                if (selectedDate && dateStr === selectedDate) {
                    cell.classList.add('selected');
                }
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                cell.appendChild(dayNumber);
                
                const completionIndicator = document.createElement('div');
                completionIndicator.className = 'completion-indicator';
                
                const data = getData(dateStr);
                const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
                const schedule = scheduleByDay[dayName] || [];
                
                // Check for overdue items on this date
                const now = new Date();
                const isToday = dateObj.toDateString() === now.toDateString();
                const isPast = dateObj < today && !isToday;
                
                // Create dots in chronological order based on schedule
                schedule.forEach(scheduleItem => {
                    const habitId = getHabitIdFromScheduleText(scheduleItem.habit);
                    if (!habitId) return; // Skip if no matching habit
                    
                    const habit = habits.find(h => h.id === habitId);
                    if (!habit) return;
                    
                    const dot = document.createElement('div');
                    dot.className = 'completion-dot';
                    dot.setAttribute('data-habit-id', habitId);
                    dot.setAttribute('data-date', dateStr);
                    
                    const habitData = data[habitId];
                    const isCompleted = habitData?.completed || false;
                    
                    if (isCompleted) {
                        dot.classList.add('completed');
                    } else if (isPast) {
                        // Past date, not completed, was scheduled = overdue
                        dot.classList.add('overdue');
                    }
                    
                    completionIndicator.appendChild(dot);
                });
                
                cell.appendChild(completionIndicator);
                
                cell.onclick = () => selectDate(dateStr);
                calendar.appendChild(cell);
            }
            
            updateTodayOverview();
        }

        function selectDate(dateStr) {
            selectedDate = dateStr;
            renderCalendar();
            renderDailySchedule();
        }

        function renderDailySchedule() {
            const scheduleList = document.getElementById('scheduleList');
            const selectedDateTitle = document.getElementById('selectedDateTitle');
            const scheduleDayName = document.getElementById('scheduleDayName');
            
            if (!selectedDate) {
                selectedDateTitle.textContent = 'Select a date';
                scheduleDayName.textContent = '';
                scheduleList.innerHTML = '<div class="schedule-empty">Select a date from the calendar above to view and track your daily schedule</div>';
                return;
            }
            
            const date = new Date(selectedDate + 'T12:00:00');
            const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
            
            selectedDateTitle.textContent = date.toLocaleDateString('en-US', { 
                month: 'long', 
                day: 'numeric',
                year: 'numeric'
            });
            scheduleDayName.textContent = dayName;
            
            scheduleList.innerHTML = '';
            
            const schedule = scheduleByDay[dayName] || [];
            const data = getData(selectedDate);
            
            if (schedule.length === 0) {
                scheduleList.innerHTML = '<div class="schedule-empty">No schedule items for this day</div>';
                return;
            }
            
            schedule.forEach((scheduleItem, index) => {
                // Find matching habit
                const habitId = getHabitIdFromScheduleText(scheduleItem.habit);
                const habit = habits.find(h => h.id === habitId);
                
                if (!habit) return; // Skip if no matching habit
                
                const habitData = data[habit.id] || { completed: false, notes: '' };
                
                const item = document.createElement('div');
                item.className = 'schedule-habit-item';
                if (habitData.completed) {
                    item.classList.add('completed');
                }
                
                const header = document.createElement('div');
                header.className = 'schedule-habit-header';
                
                const time = document.createElement('div');
                time.className = 'schedule-habit-time';
                time.textContent = scheduleItem.time;
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'schedule-habit-checkbox';
                checkbox.checked = habitData.completed;
                checkbox.onchange = (e) => {
                    updateHabitStatus(habit.id, e.target.checked);
                    renderDailySchedule(); // Refresh to show completed state
                };
                
                const name = document.createElement('span');
                name.className = 'schedule-habit-name';
                name.textContent = habit.name;
                
                const category = document.createElement('span');
                category.className = 'schedule-habit-category';
                category.textContent = habit.category;
                
                header.appendChild(time);
                header.appendChild(checkbox);
                header.appendChild(name);
                header.appendChild(category);
                
                const notes = document.createElement('textarea');
                notes.className = 'schedule-habit-notes';
                notes.placeholder = 'Notes';
                notes.value = habitData.notes;
                notes.oninput = (e) => {
                    updateHabitNotes(habit.id, e.target.value);
                };
                
                item.appendChild(header);
                item.appendChild(notes);
                scheduleList.appendChild(item);
            });
        }

        function getHabitIdFromScheduleText(habitText) {
            const habitLower = habitText.toLowerCase();
            
            // Map schedule text to habit IDs
            if (habitLower.includes('wake up') || habitLower.includes('hydrate')) return 'wakeup';
            if (habitLower.includes('dead hang')) return 'deadhang';
            if (habitLower.includes('beard oil')) return 'beardoil';
            if (habitLower.includes('microneedling')) return 'microneedling';
            if (habitLower.includes('pre-workout supplements')) return 'supplements_pre';
            if (habitLower.includes('workout') && !habitLower.includes('pre-workout')) return 'workout';
            if (habitLower.includes('climbing')) return 'climbing';
            if (habitLower.includes('shower')) return 'shower';
            if (habitLower.includes('hair styling')) return 'hairstyle';
            if (habitLower.includes('meal 1')) return 'meal1';
            if (habitLower.includes('meal 2')) return 'meal2';
            if (habitLower.includes('meal 3')) return 'meal3';
            if (habitLower.includes('meal 4')) return 'meal4';
            if (habitLower.includes('meal 5')) return 'meal5';
            if (habitLower.includes('morning supplements')) return 'supplements_am';
            if (habitLower.includes('post-workout')) return 'supplements_post';
            if (habitLower.includes('evening supplements')) return 'supplements_pm';
            if (habitLower.includes('leave for work') || (habitLower.includes('commute') && habitLower.includes('work'))) return 'commute_work';
            if (habitLower.includes('arrive home') || (habitLower.includes('commute') && habitLower.includes('home'))) return 'commute_home';
            if (habitLower.includes('manscaping')) return 'manscaping';
            if (habitLower.includes('golf')) return 'golf';
            if (habitLower.includes('yoga')) return 'yoga';
            if (habitLower.includes('relax') || habitLower.includes('free time') || habitLower.includes('hobby')) return 'relax';
            if (habitLower.includes('walk') || habitLower.includes('bike') || habitLower.includes('light')) return 'walk';
            if (habitLower.includes('stretching') || habitLower.includes('mobility')) return 'stretching';
            if (habitLower.includes('foam rolling')) return 'foam_rolling';
            if (habitLower.includes('errands') || habitLower.includes('shopping') || habitLower.includes('activities')) return 'errands';
            if (habitLower.includes('meal prep')) return 'meal_prep';
            if (habitLower.includes('full grooming') || habitLower.includes('grooming session')) return 'grooming_full';
            if (habitLower.includes('bed')) return 'bed';
            
            return null;
        }

        // Settings Panel Management
        function openSettings() {
            document.getElementById('settingsPanel').classList.add('active');
            renderCategoryList();
            renderHabitEditor();
            renderScheduleEditor();
        }

        function closeSettings() {
            document.getElementById('settingsPanel').classList.remove('active');
            // Refresh the main view in case habits or schedule changed
            renderCalendar();
            if (selectedDate) {
                renderDailySchedule();
            }
        }

        // Category CRUD Operations
        function renderCategoryList() {
            const container = document.getElementById('categoryList');
            container.innerHTML = '';

            categories.forEach((category, index) => {
                const item = document.createElement('div');
                item.className = 'category-item';

                const badge = document.createElement('div');
                badge.className = 'category-badge';
                badge.textContent = category;

                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'category-input';
                input.value = category;
                input.onchange = (e) => updateCategory(index, e.target.value);

                const usage = document.createElement('div');
                usage.className = 'category-usage';
                const count = habits.filter(h => h.category === category).length;
                usage.textContent = `${count} habit${count !== 1 ? 's' : ''}`;

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-delete-category';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => deleteCategory(index);

                item.appendChild(badge);
                item.appendChild(input);
                item.appendChild(usage);
                item.appendChild(deleteBtn);
                container.appendChild(item);
            });
        }

        function updateCategory(index, newName) {
            if (!newName.trim()) {
                alert('Category name cannot be empty');
                renderCategoryList();
                return;
            }

            const oldName = categories[index];
            
            // Check for duplicates
            if (categories.some((cat, i) => i !== index && cat.toLowerCase() === newName.toLowerCase())) {
                alert('A category with this name already exists');
                renderCategoryList();
                return;
            }

            // Update category name
            categories[index] = newName;

            // Update all habits using this category
            habits.forEach(habit => {
                if (habit.category === oldName) {
                    habit.category = newName;
                }
            });

            saveCategories();
            saveHabits();
            renderCategoryList();
            renderHabitEditor();
        }

        function deleteCategory(index) {
            const categoryName = categories[index];
            const affectedHabits = habits.filter(h => h.category === categoryName);
            
            if (affectedHabits.length > 0) {
                const confirmMsg = `Delete "${categoryName}"? ${affectedHabits.length} habit(s) will be changed to "Uncategorized":\n\n` +
                    affectedHabits.map(h => `‚Ä¢ ${h.name}`).join('\n');
                
                if (!confirm(confirmMsg)) {
                    return;
                }

                // Update affected habits to "Uncategorized"
                habits.forEach(habit => {
                    if (habit.category === categoryName) {
                        habit.category = 'Uncategorized';
                    }
                });

                // Add "Uncategorized" if it doesn't exist
                if (!categories.includes('Uncategorized')) {
                    categories.push('Uncategorized');
                }

                saveHabits();
            } else {
                if (!confirm(`Delete category "${categoryName}"?`)) {
                    return;
                }
            }

            categories.splice(index, 1);
            saveCategories();
            renderCategoryList();
            renderHabitEditor();
        }

        function addNewCategory() {
            const newName = prompt('Enter new category name:');
            
            if (!newName || !newName.trim()) {
                return;
            }

            const trimmedName = newName.trim();

            // Check for duplicates
            if (categories.some(cat => cat.toLowerCase() === trimmedName.toLowerCase())) {
                alert('A category with this name already exists');
                return;
            }

            categories.push(trimmedName);
            saveCategories();
            renderCategoryList();
            renderHabitEditor();
        }

        function saveCategories() {
            localStorage.setItem('custom_categories', JSON.stringify(categories));
            // Trigger UI refresh for habit list in case category badges changed
            if (selectedDate) {
                renderDailySchedule();
            }
        }

        function loadCategories() {
            const saved = localStorage.getItem('custom_categories');
            if (saved) {
                categories = JSON.parse(saved);
            }
        }

        // Habit CRUD Operations
        function renderHabitEditor() {
            const container = document.getElementById('habitEditorList');
            container.innerHTML = '';

            habits.forEach((habit, index) => {
                const item = document.createElement('div');
                item.className = 'habit-edit-item';

                const header = document.createElement('div');
                header.className = 'habit-edit-header';

                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'habit-edit-input';
                nameInput.value = habit.name;
                nameInput.onchange = (e) => updateHabitName(index, e.target.value);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-delete-habit';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => deleteHabit(index);

                header.appendChild(nameInput);
                header.appendChild(deleteBtn);

                const categorySelect = document.createElement('select');
                categorySelect.className = 'habit-edit-category';
                
                // Use dynamic categories from global array
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    if (cat === habit.category) option.selected = true;
                    categorySelect.appendChild(option);
                });
                
                categorySelect.onchange = (e) => updateHabitCategory(index, e.target.value);

                item.appendChild(header);
                item.appendChild(categorySelect);
                container.appendChild(item);
            });
        }

        function updateHabitName(index, newName) {
            habits[index].name = newName;
            saveHabits();
        }

        function updateHabitCategory(index, newCategory) {
            habits[index].category = newCategory;
            saveHabits();
        }

        function deleteHabit(index) {
            if (confirm(`Delete "${habits[index].name}"? This will remove it from all dates.`)) {
                habits.splice(index, 1);
                saveHabits();
                renderHabitEditor();
            }
        }

        function addNewHabit() {
            const newId = 'habit_' + Date.now();
            habits.push({
                id: newId,
                name: 'New Habit',
                category: 'Fitness',
                schedule: true
            });
            saveHabits();
            renderHabitEditor();
        }

        function saveHabits() {
            localStorage.setItem('custom_habits', JSON.stringify(habits));
            // Trigger UI refresh
            if (selectedDate) {
                renderDailySchedule();
            }
            renderCalendar();
            updateTodayOverview();
            updateStats();
        }

        function loadHabits() {
            const saved = localStorage.getItem('custom_habits');
            if (saved) {
                const parsed = JSON.parse(saved);
                // Merge with defaults, keeping custom ones
                habits.length = 0;
                habits.push(...parsed);
            }
        }

        // Schedule CRUD Operations
        function renderScheduleEditor() {
            const day = document.getElementById('scheduleEditDay').value;
            const container = document.getElementById('scheduleEditorList');
            container.innerHTML = '';

            const schedule = scheduleByDay[day] || [];

            schedule.forEach((item, index) => {
                const editItem = document.createElement('div');
                editItem.className = 'schedule-edit-item';

                const row = document.createElement('div');
                row.className = 'schedule-edit-row';

                const timeInput = document.createElement('input');
                timeInput.type = 'text';
                timeInput.className = 'time-input';
                timeInput.value = item.time;
                timeInput.placeholder = '8:00 AM';
                timeInput.onchange = (e) => updateScheduleTime(day, index, e.target.value);

                const habitInput = document.createElement('input');
                habitInput.type = 'text';
                habitInput.className = 'habit-input';
                habitInput.value = item.habit;
                habitInput.onchange = (e) => updateScheduleHabit(day, index, e.target.value);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-delete-schedule';
                deleteBtn.textContent = 'X';
                deleteBtn.onclick = () => deleteScheduleItem(day, index);

                row.appendChild(timeInput);
                row.appendChild(habitInput);
                row.appendChild(deleteBtn);

                editItem.appendChild(row);
                container.appendChild(editItem);
            });
        }

        function updateScheduleTime(day, index, newTime) {
            scheduleByDay[day][index].time = newTime;
            saveSchedule();
        }

        function updateScheduleHabit(day, index, newHabit) {
            scheduleByDay[day][index].habit = newHabit;
            saveSchedule();
        }

        function deleteScheduleItem(day, index) {
            scheduleByDay[day].splice(index, 1);
            saveSchedule();
            renderScheduleEditor();
        }

        function addNewScheduleItem() {
            const day = document.getElementById('scheduleEditDay').value;
            if (!scheduleByDay[day]) {
                scheduleByDay[day] = [];
            }
            scheduleByDay[day].push({
                time: '12:00 PM',
                habit: 'New Activity'
            });
            saveSchedule();
            renderScheduleEditor();
        }

        function saveSchedule() {
            localStorage.setItem('custom_schedule', JSON.stringify(scheduleByDay));
            // Trigger UI refresh
            if (selectedDate) {
                renderDailySchedule();
            }
            updateTodayOverview();
        }

        function loadSchedule() {
            const saved = localStorage.getItem('custom_schedule');
            if (saved) {
                const parsed = JSON.parse(saved);
                Object.keys(parsed).forEach(day => {
                    scheduleByDay[day] = parsed[day];
                });
            }
        }

        // Data Management
        function viewAllData() {
            const allData = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                allData[key] = localStorage.getItem(key);
            }
            
            document.getElementById('dataViewContent').textContent = JSON.stringify(allData, null, 2);
            document.getElementById('dataViewModal').classList.add('active');
        }

        function closeDataView() {
            document.getElementById('dataViewModal').classList.remove('active');
        }

        function getData(dateStr) {
            const data = localStorage.getItem(`habit_${dateStr}`);
            return data ? JSON.parse(data) : {};
        }

        function setData(dateStr, data) {
            localStorage.setItem(`habit_${dateStr}`, JSON.stringify(data));
            updateStats();
            
            // Always update today overview in case overdue status changed
            updateTodayOverview();
        }

        function updateHabitStatus(habitId, completed) {
            const data = getData(selectedDate);
            if (!data[habitId]) {
                data[habitId] = { completed: false, notes: '' };
            }
            data[habitId].completed = completed;
            setData(selectedDate, data);
            
            // Live update the specific dot in calendar
            updateCalendarDot(selectedDate, habitId, completed);
            
            // Refresh daily schedule view
            renderDailySchedule();
            
            // Force update today overview to catch any new overdue items
            updateTodayOverview();
        }

        function updateCalendarDot(dateStr, habitId, completed) {
            // Find the specific dot for this habit and date
            const dots = document.querySelectorAll(`.completion-dot[data-habit-id="${habitId}"][data-date="${dateStr}"]`);
            
            dots.forEach(dot => {
                // Remove all status classes
                dot.classList.remove('completed', 'overdue');
                
                // Add appropriate class
                if (completed) {
                    dot.classList.add('completed');
                } else {
                    // Check if this is a past date
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const dotDate = new Date(dateStr + 'T00:00:00');
                    dotDate.setHours(0, 0, 0, 0);
                    
                    const isPast = dotDate < today;
                    const isToday = dotDate.toDateString() === today.toDateString();
                    
                    if (isPast && !isToday) {
                        dot.classList.add('overdue');
                    }
                }
            });
        }

        function updateHabitNotes(habitId, notes) {
            const data = getData(selectedDate);
            if (!data[habitId]) {
                data[habitId] = { completed: false, notes: '' };
            }
            data[habitId].notes = notes;
            setData(selectedDate, data);
        }

        function updateStats() {
            // Stats calculation kept for potential future use
            // Currently no stats display in UI
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function exportData() {
            const allData = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('habit_')) {
                    allData[key] = localStorage.getItem(key);
                }
            }
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `habit-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    Object.keys(data).forEach(key => {
                        localStorage.setItem(key, data[key]);
                    });
                    renderCalendar();
                    renderHabitList();
                    updateStats();
                    alert('Data imported successfully!');
                } catch (error) {
                    alert('Error importing data. Please check the file format.');
                }
            };
            reader.readAsText(file);
        }

        function confirmClear() {
            document.getElementById('clearModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('clearModal').classList.remove('active');
        }

        function clearAllData() {
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('habit_')) {
                    keys.push(key);
                }
            }
            keys.forEach(key => localStorage.removeItem(key));
            
            closeModal();
            renderCalendar();
            renderHabitList();
            updateStats();
            alert('All data cleared successfully!');
        }

        initializeTracker();
    </script>
</body>
</html>
