<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Habit Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            overflow-x: hidden;
        }

        /* Password Screen */
        #passwordScreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        #passwordScreen.hidden {
            display: none;
        }

        .password-box {
            padding: 40px;
            max-width: 400px;
            width: 90%;
        }

        .password-box h1 {
            font-size: 2em;
            margin-bottom: 10px;
            color: #000000;
        }

        .password-box p {
            color: #666666;
            margin-bottom: 30px;
        }

        .password-box input {
            width: 100%;
            padding: 16px;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 16px;
        }

        .password-box input:focus {
            outline: none;
            border-color: #000000;
        }

        .password-box button {
            width: 100%;
            padding: 16px;
            background: #000000;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .password-box button:active {
            background: #333333;
        }

        .password-error {
            color: #dc3545;
            margin-top: 12px;
            display: none;
        }

        .password-error.show {
            display: block;
        }

        /* Main App */
        #app {
            display: none;
        }

        #app.unlocked {
            display: block;
        }

        .container {
            max-width: 100%;
            margin: 0;
            background: #ffffff;
            padding: 0;
            padding-bottom: 80px;
        }

        button {
            background: #000000;
            color: #ffffff;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        button:active {
            background: #333333;
            transform: scale(0.97);
        }

        /* Overdue Section (Up Next removed) */
        .today-overview {
            background: #ffffff;
            border-bottom: 1px solid #e5e5e5;
        }

        .overview-section {
            padding: 16px;
            border-bottom: 1px solid #e5e5e5;
        }

        .overview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .overview-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #000000;
        }

        .overview-count {
            font-size: 0.9em;
            font-weight: 600;
            color: #666666;
            background: #f5f5f5;
            padding: 4px 10px;
            border-radius: 12px;
        }

        .overview-list {
            display: grid;
            gap: 8px;
        }

        .overview-item {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 3px solid #dc3545;
        }

        .overview-time {
            font-size: 0.85em;
            font-weight: 700;
            color: #000000;
            min-width: 70px;
        }

        .overview-habit {
            font-size: 0.95em;
            color: #000000;
            flex: 1;
            line-height: 1.3;
        }

        .overview-empty {
            text-align: center;
            color: #999999;
            font-size: 0.9em;
            padding: 20px;
        }

        .overview-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #000000;
            flex-shrink: 0;
        }

        /* Calendar Container */
        .calendar-container {
            position: relative;
            background: #ffffff;
            border-bottom: 1px solid #e5e5e5;
        }

        .calendar-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #f5f5f5;
            border-bottom: 1px solid #e5e5e5;
            gap: 8px;
        }

        .year-selector,
        .month-selector {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e5e5e5;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            background: #ffffff;
            color: #000000;
            cursor: pointer;
        }

        .year-selector:focus,
        .month-selector:focus {
            outline: none;
            border-color: #000000;
        }

        .btn-today {
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 6px;
            background: #000000;
            color: #ffffff;
            white-space: nowrap;
            flex-shrink: 0;
        }

        /* Calendar */
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            padding: 12px;
            background: #ffffff;
        }

        .day-header {
            text-align: center;
            font-weight: 600;
            padding: 12px 4px;
            background: #f5f5f5;
            border-radius: 6px;
            color: #000000;
            font-size: 0.85em;
        }

        .day-cell {
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            padding: 8px 4px;
            min-height: 70px;
            cursor: pointer;
            background: #ffffff;
            position: relative;
            touch-action: manipulation;
        }

        .day-cell:active {
            background: #f5f5f5;
        }

        .day-cell.empty {
            background: #fafafa;
            border-color: #f0f0f0;
            cursor: default;
        }

        /* Grey for current day */
        .day-cell.today {
            border-color: #999999;
            border-width: 3px;
            background: #f9f9f9;
        }

        /* Blue for selected day */
        .day-cell.selected {
            border-color: #007AFF;
            background: #E3F2FD;
            border-width: 3px;
        }

        .day-cell.today.selected {
            border-color: #007AFF;
            background: #E3F2FD;
            border-width: 3px;
        }

        .day-number {
            font-weight: 700;
            font-size: 1em;
            color: #000000;
            margin-bottom: 6px;
            text-align: center;
        }

        .day-cell.today .day-number {
            background: #999999;
            color: #ffffff;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin: 0 auto 6px auto;
        }

        .day-cell.selected .day-number {
            color: #007AFF;
        }

        .day-cell.today.selected .day-number {
            background: #007AFF;
            color: #ffffff;
        }

        .completion-indicator {
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 6px;
        }

        .completion-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #d0d0d0;
        }

        .completion-dot.completed {
            background: #34C759;
        }

        .completion-dot.overdue {
            background: #dc3545;
        }

        /* Daily Schedule Section */
        .daily-schedule-section {
            background: #ffffff;
            padding: 20px 16px;
        }

        .daily-schedule-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .selected-date-info {
            flex: 1;
        }

        .selected-date-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #000000;
            margin-bottom: 4px;
        }

        .schedule-day-name {
            font-size: 1em;
            color: #666666;
            font-weight: 500;
        }

        .toggle-completed-btn {
            background: #f5f5f5;
            color: #000000;
            border: 1px solid #e5e5e5;
            padding: 8px 16px;
            font-size: 14px;
            white-space: nowrap;
        }

        .toggle-completed-btn:active {
            background: #e5e5e5;
        }

        .schedule-list {
            display: grid;
            gap: 12px;
        }

        .schedule-habit-item {
            background: #ffffff;
            border-radius: 12px;
            padding: 16px;
            border: 2px solid #e5e5e5;
        }

        .schedule-habit-item.overdue {
            border-left: 4px solid #dc3545;
            background: #FFF5F5;
        }

        .schedule-habit-item:active {
            background: #fafafa;
        }

        .schedule-habit-item.overdue:active {
            background: #FFEBEE;
        }

        .schedule-habit-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .schedule-habit-time {
            font-size: 0.9em;
            font-weight: 700;
            color: #000000;
            min-width: 75px;
        }

        .schedule-habit-checkbox {
            width: 28px;
            height: 28px;
            cursor: pointer;
            accent-color: #000000;
            flex-shrink: 0;
        }

        .schedule-habit-name {
            font-weight: 600;
            font-size: 1em;
            color: #000000;
            flex: 1;
            line-height: 1.3;
        }

        .schedule-habit-details {
            font-size: 0.85em;
            color: #666666;
            margin-top: 8px;
            padding-left: 115px;
            line-height: 1.4;
        }

        .schedule-habit-item.completed {
            opacity: 0.4;
        }

        .schedule-habit-item.hidden {
            display: none;
        }

        .schedule-empty {
            text-align: center;
            color: #999999;
            padding: 40px 20px;
            font-size: 0.95em;
        }

        /* Management Menu */
        .management-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #ffffff;
            border-top: 2px solid #e5e5e5;
            padding: 12px 16px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            display: flex;
            gap: 8px;
            z-index: 50;
        }

        .management-menu button {
            flex: 1;
            padding: 12px 8px;
            font-size: 13px;
            background: #f5f5f5;
            color: #000000;
            border: 1px solid #e5e5e5;
        }

        .management-menu button:active {
            background: #e5e5e5;
        }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ffffff;
            z-index: 200;
            display: none;
            overflow-y: auto;
        }

        .settings-panel.active {
            display: block;
        }

        .settings-header {
            position: sticky;
            top: 0;
            background: #ffffff;
            border-bottom: 1px solid #e5e5e5;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .settings-header h2 {
            font-size: 1.5em;
            font-weight: 700;
            color: #000000;
        }

        .settings-content {
            padding: 16px;
            padding-bottom: 100px;
        }

        .settings-section {
            margin-bottom: 32px;
        }

        .settings-section h3 {
            font-size: 1.2em;
            font-weight: 600;
            color: #000000;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e5e5;
        }

        /* Schedule Editor */
        .schedule-editor {
            display: grid;
            gap: 12px;
        }

        .schedule-edit-item {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 12px;
            border: 2px solid #e5e5e5;
        }

        .schedule-edit-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .time-input {
            width: 90px;
            padding: 8px;
            border: 2px solid #e5e5e5;
            border-radius: 6px;
            font-size: 14px;
            background: #ffffff;
            font-weight: 600;
        }

        .habit-select {
            flex: 1;
            padding: 8px;
            border: 2px solid #e5e5e5;
            border-radius: 6px;
            font-size: 14px;
            background: #ffffff;
        }

        .btn-delete-schedule {
            background: #000000;
            color: #ffffff;
            padding: 6px 10px;
            font-size: 12px;
            border-radius: 6px;
            white-space: nowrap;
        }

        .btn-add-schedule {
            width: 100%;
            padding: 10px;
            background: #000000;
            color: #ffffff;
            font-size: 13px;
            margin-top: 8px;
        }

        .day-selector {
            margin-bottom: 16px;
        }

        .day-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            font-size: 15px;
            background: #ffffff;
            font-weight: 600;
        }

        /* Data Management */
        .data-actions {
            display: grid;
            gap: 12px;
        }

        .data-action-item {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 16px;
            border: 2px solid #e5e5e5;
        }

        .data-action-item h4 {
            font-size: 1.1em;
            font-weight: 600;
            color: #000000;
            margin-bottom: 8px;
        }

        .data-action-item p {
            font-size: 0.9em;
            color: #666666;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .data-action-item button {
            width: 100%;
        }

        .btn-close {
            background: #f5f5f5;
            color: #000000;
            padding: 8px 16px;
            border: 1px solid #e5e5e5;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #ffffff;
            padding: 24px;
            border-radius: 16px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            color: #000000;
            margin-bottom: 16px;
            font-size: 1.3em;
        }

        .modal-content p {
            color: #333333;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-buttons button {
            min-width: 80px;
        }

        /* iPhone optimizations */
        @media (max-width: 428px) {
            .calendar {
                padding: 8px;
                gap: 3px;
            }

            .day-cell {
                min-height: 60px;
                padding: 6px 2px;
            }

            .day-number {
                font-size: 0.9em;
            }

            .completion-dot {
                width: 5px;
                height: 5px;
            }

            .schedule-habit-details {
                padding-left: 0;
                margin-top: 8px;
            }
        }

        /* Safe area for iPhone */
        @supports (padding: max(0px)) {
            body {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
    </style>
</head>
<body>
    <!-- Password Screen -->
    <div id="passwordScreen">
        <div class="password-box">
            <h1>üîí Habit Tracker</h1>
            <p>Enter password to access</p>
            <input type="password" id="passwordInput" placeholder="Password" autocomplete="off">
            <button onclick="checkPassword()">Unlock</button>
            <div class="password-error" id="passwordError">Incorrect password. Please try again.</div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app">
        <div class="container">
            <!-- Overdue Section Only -->
            <div class="today-overview">
                <div class="overview-section" id="overdueSection" style="display: none;">
                    <div class="overview-header">
                        <div class="overview-title">‚ö†Ô∏è Overdue</div>
                        <div class="overview-count" id="overdueCount">0</div>
                    </div>
                    <div class="overview-list" id="overdueList"></div>
                </div>
            </div>

            <!-- Calendar -->
            <div class="calendar-container">
                <div class="calendar-controls">
                    <select class="year-selector" id="yearSelector" onchange="updateCalendarMonth()"></select>
                    <select class="month-selector" id="monthSelector" onchange="updateCalendarMonth()"></select>
                    <button class="btn-today" onclick="selectToday()">Today</button>
                </div>
                <div class="calendar" id="calendar"></div>
            </div>

            <!-- Daily Schedule -->
            <div class="daily-schedule-section" id="dailyScheduleSection">
                <div class="daily-schedule-header">
                    <div class="selected-date-info">
                        <div class="selected-date-title" id="selectedDateTitle">Select a date</div>
                        <div class="schedule-day-name" id="scheduleDayName"></div>
                    </div>
                    <button class="toggle-completed-btn" id="toggleCompletedBtn" onclick="toggleCompletedItems()" style="display: none;">
                        Show Completed
                    </button>
                </div>
                <div class="schedule-list" id="scheduleList"></div>
            </div>

            <!-- Management Menu (Import button removed) -->
            <div class="management-menu">
                <button onclick="openSettings()">Manage</button>
                <button onclick="exportData()">Export</button>
            </div>

            <!-- Settings Panel -->
            <div class="settings-panel" id="settingsPanel">
                <div class="settings-header">
                    <h2>Manage Schedule</h2>
                    <button class="btn-close" onclick="closeSettings()">Done</button>
                </div>
                <div class="settings-content">

                    <!-- Schedule Editor -->
                    <div class="settings-section">
                        <h3>Edit Schedule</h3>
                        <div class="day-selector">
                            <select id="scheduleEditDay" onchange="renderScheduleEditor()">
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                                <option value="Sunday">Sunday</option>
                            </select>
                        </div>
                        <div class="schedule-editor" id="scheduleEditorList"></div>
                        <button class="btn-add-schedule" onclick="addNewScheduleItem()">+ Add Schedule Item</button>
                    </div>

                    <!-- Data Management -->
                    <div class="settings-section">
                        <h3>Data Management</h3>
                        <div class="data-actions">
                            <div class="data-action-item">
                                <h4>View All Data</h4>
                                <p>See all your tracked completion data in JSON format</p>
                                <button onclick="viewAllData()">View Data</button>
                            </div>
                            <div class="data-action-item">
                                <h4>Export Backup</h4>
                                <p>Download all your completion data to your device</p>
                                <button onclick="exportData()">Export Data</button>
                            </div>
                            <div class="data-action-item">
                                <h4>Clear All Data</h4>
                                <p>Permanently delete all tracked completion data</p>
                                <button onclick="confirmClear()">Clear All Data</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Modals -->
        <div class="modal" id="clearModal">
            <div class="modal-content">
                <h3>Clear All Data?</h3>
                <p>This will permanently delete all your tracked habits. This action cannot be undone.</p>
                <div class="modal-buttons">
                    <button onclick="closeModal()">Cancel</button>
                    <button onclick="clearAllData()">Yes, Clear All</button>
                </div>
            </div>
        </div>

        <div class="modal" id="dataViewModal">
            <div class="modal-content" style="max-width: 90%;">
                <h3>All Saved Data</h3>
                <pre id="dataViewContent" style="background: #f5f5f5; padding: 16px; border-radius: 8px; font-size: 12px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"></pre>
                <div class="modal-buttons">
                    <button onclick="closeDataView()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load private configuration -->
    <script src="config-private.js"></script>

    <script>
        // State
        let currentDate = new Date();
        let selectedDate = null;
        let showCompleted = false;
        let habits = [];
        let categories = [];
        let scheduleByDay = {};

        // Password Protection
        function checkPassword() {
            const input = document.getElementById('passwordInput');
            const error = document.getElementById('passwordError');

            if (input.value === CONFIG.password) {
                document.getElementById('passwordScreen').classList.add('hidden');
                document.getElementById('app').classList.add('unlocked');
                initializeTracker();
            } else {
                error.classList.add('show');
                input.value = '';
                input.focus();
            }
        }

        // Enter key to submit password
        document.getElementById('passwordInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        function initializeTracker() {
            // Load configuration
            habits = CONFIG.habits;
            categories = CONFIG.categories;
            scheduleByDay = CONFIG.schedule;

            // Initialize calendar
            initializeCalendarControls();

            // Select today by default
            const today = new Date();
            selectedDate = today.toISOString().split('T')[0];

            renderCalendar();
            renderDailySchedule();
            updateTodayOverview();

            // Update overview every minute
            setInterval(updateTodayOverview, 60000);
        }

        function initializeCalendarControls() {
            const yearSelector = document.getElementById('yearSelector');
            const monthSelector = document.getElementById('monthSelector');

            // Populate years
            const currentYear = new Date().getFullYear();
            for (let year = currentYear - 2; year <= currentYear + 2; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelector.appendChild(option);
            }

            // Populate months
            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                monthSelector.appendChild(option);
            });

            // Set current
            yearSelector.value = currentDate.getFullYear();
            monthSelector.value = currentDate.getMonth();
        }

        function updateCalendarMonth() {
            const year = parseInt(document.getElementById('yearSelector').value);
            const month = parseInt(document.getElementById('monthSelector').value);
            currentDate = new Date(year, month, 1);
            renderCalendar();
        }

        function selectToday() {
            const today = new Date();
            selectedDate = today.toISOString().split('T')[0];
            currentDate = new Date(today.getFullYear(), today.getMonth(), 1);

            document.getElementById('yearSelector').value = today.getFullYear();
            document.getElementById('monthSelector').value = today.getMonth();

            renderCalendar();
            renderDailySchedule();
        }

        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            // Day headers
            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            daysOfWeek.forEach(day => {
                const header = document.createElement('div');
                header.className = 'day-header';
                header.textContent = day;
                calendar.appendChild(header);
            });

            // Empty cells
            const firstDay = new Date(year, month, 1).getDay();
            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'day-cell empty';
                calendar.appendChild(empty);
            }

            // Days
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                cell.className = 'day-cell';

                const dateObj = new Date(year, month, day);
                const dateStr = dateObj.toISOString().split('T')[0];

                // Mark today
                if (dateObj.toDateString() === today.toDateString()) {
                    cell.classList.add('today');
                }

                // Mark selected
                if (selectedDate && dateStr === selectedDate) {
                    cell.classList.add('selected');
                }

                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                cell.appendChild(dayNumber);

                // Completion dots
                const indicator = document.createElement('div');
                indicator.className = 'completion-indicator';

                const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
                const schedule = scheduleByDay[dayName] || [];
                const data = getData(dateStr);

                const isPast = dateObj < today && dateObj.toDateString() !== today.toDateString();

                // Create dots for each unique habit in schedule
                const processedHabits = new Set();
                schedule.forEach(item => {
                    // Track unique schedule instance
                    const instanceKey = `${item.habitId}_${item.time}`;
                    if (processedHabits.has(instanceKey)) return;
                    processedHabits.add(instanceKey);

                    const habitData = data[instanceKey];
                    const isCompleted = habitData?.completed || false;

                    const dot = document.createElement('div');
                    dot.className = 'completion-dot';

                    if (isCompleted) {
                        dot.classList.add('completed');
                    } else if (isPast) {
                        dot.classList.add('overdue');
                    }

                    indicator.appendChild(dot);
                });

                cell.appendChild(indicator);
                cell.onclick = () => selectDate(dateStr);
                calendar.appendChild(cell);
            }

            updateTodayOverview();
        }

        function selectDate(dateStr) {
            selectedDate = dateStr;
            showCompleted = false;
            renderCalendar();
            renderDailySchedule();
        }

        function renderDailySchedule() {
            const scheduleList = document.getElementById('scheduleList');
            const titleEl = document.getElementById('selectedDateTitle');
            const dayNameEl = document.getElementById('scheduleDayName');
            const toggleBtn = document.getElementById('toggleCompletedBtn');

            if (!selectedDate) {
                titleEl.textContent = 'Select a date';
                dayNameEl.textContent = '';
                scheduleList.innerHTML = '<div class="schedule-empty">Select a date from the calendar above</div>';
                toggleBtn.style.display = 'none';
                return;
            }

            const date = new Date(selectedDate + 'T12:00:00');
            const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });

            titleEl.textContent = date.toLocaleDateString('en-US', {
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
            dayNameEl.textContent = dayName;

            const schedule = scheduleByDay[dayName] || [];
            const data = getData(selectedDate);

            if (schedule.length === 0) {
                scheduleList.innerHTML = '<div class="schedule-empty">No schedule for this day</div>';
                toggleBtn.style.display = 'none';
                return;
            }

            // Sort schedule chronologically
            const sortedSchedule = [...schedule].sort((a, b) => {
                return parseTimeToMinutes(a.time) - parseTimeToMinutes(b.time);
            });

            // Check if any completed items exist
            const hasCompleted = sortedSchedule.some(item => {
                const instanceKey = `${item.habitId}_${item.time}`;
                return data[instanceKey]?.completed;
            });

            toggleBtn.style.display = hasCompleted ? 'block' : 'none';
            toggleBtn.textContent = showCompleted ? 'Hide Completed' : 'Show Completed';

            scheduleList.innerHTML = '';

            // Check if selected date is today
            const today = new Date();
            const isToday = date.toDateString() === today.toDateString();
            const isPast = date < today && !isToday;
            const currentMinutes = today.getHours() * 60 + today.getMinutes();

            sortedSchedule.forEach((item, index) => {
                const habit = habits.find(h => h.id === item.habitId);
                if (!habit) return;

                // Unique instance key
                const instanceKey = `${item.habitId}_${item.time}`;
                const habitData = data[instanceKey] || { completed: false };

                const itemEl = document.createElement('div');
                itemEl.className = 'schedule-habit-item';

                if (habitData.completed) {
                    itemEl.classList.add('completed');
                    if (!showCompleted) {
                        itemEl.classList.add('hidden');
                    }
                }

                // Check if overdue
                const itemMinutes = parseTimeToMinutes(item.time);
                if (isToday && !habitData.completed && itemMinutes < currentMinutes) {
                    itemEl.classList.add('overdue');
                } else if (isPast && !habitData.completed) {
                    itemEl.classList.add('overdue');
                }

                const header = document.createElement('div');
                header.className = 'schedule-habit-header';

                const time = document.createElement('div');
                time.className = 'schedule-habit-time';
                time.textContent = item.time;

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'schedule-habit-checkbox';
                checkbox.checked = habitData.completed;
                checkbox.onchange = (e) => {
                    updateHabitStatus(instanceKey, e.target.checked);
                };

                const name = document.createElement('span');
                name.className = 'schedule-habit-name';
                name.textContent = habit.name;

                header.appendChild(time);
                header.appendChild(checkbox);
                header.appendChild(name);

                itemEl.appendChild(header);

                // Show details if available
                if (habit.details) {
                    const details = document.createElement('div');
                    details.className = 'schedule-habit-details';
                    details.textContent = habit.details;
                    itemEl.appendChild(details);
                }

                scheduleList.appendChild(itemEl);
            });
        }

        function toggleCompletedItems() {
            showCompleted = !showCompleted;
            renderDailySchedule();
        }

        function updateTodayOverview() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const todayStr = today.toISOString().split('T')[0];
            const dayName = today.toLocaleDateString('en-US', { weekday: 'long' });

            const schedule = scheduleByDay[dayName] || [];
            const data = getData(todayStr);
            const currentMinutes = now.getHours() * 60 + now.getMinutes();

            const overdue = [];

            schedule.forEach((item) => {
                const itemMinutes = parseTimeToMinutes(item.time);
                if (itemMinutes === null) return;

                const instanceKey = `${item.habitId}_${item.time}`;
                const isCompleted = data[instanceKey]?.completed || false;

                if (!isCompleted && itemMinutes < currentMinutes) {
                    const habit = habits.find(h => h.id === item.habitId);
                    if (habit) {
                        overdue.push({
                            ...item,
                            habitName: habit.name,
                            minutesLate: currentMinutes - itemMinutes
                        });
                    }
                }
            });

            // Sort by most late
            overdue.sort((a, b) => b.minutesLate - a.minutesLate);

            const overdueSection = document.getElementById('overdueSection');
            const overdueList = document.getElementById('overdueList');
            const overdueCount = document.getElementById('overdueCount');

            if (overdue.length > 0) {
                overdueSection.style.display = 'block';
                overdueCount.textContent = overdue.length;
                overdueList.innerHTML = '';

                overdue.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'overview-item';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'overview-checkbox';
                    checkbox.onchange = () => {
                        const instanceKey = `${item.habitId}_${item.time}`;
                        updateHabitStatus(instanceKey, true);
                    };

                    const time = document.createElement('div');
                    time.className = 'overview-time';
                    time.textContent = item.time;

                    const habit = document.createElement('div');
                    habit.className = 'overview-habit';
                    habit.textContent = item.habitName;

                    el.appendChild(checkbox);
                    el.appendChild(time);
                    el.appendChild(habit);
                    overdueList.appendChild(el);
                });
            } else {
                overdueSection.style.display = 'none';
            }
        }

        function parseTimeToMinutes(timeStr) {
            const match = timeStr.match(/(\d+):(\d+)\s*(AM|PM)/i);
            if (!match) return null;

            let hours = parseInt(match[1]);
            const minutes = parseInt(match[2]);
            const period = match[3].toUpperCase();

            if (period === 'PM' && hours !== 12) hours += 12;
            if (period === 'AM' && hours === 12) hours = 0;

            return hours * 60 + minutes;
        }

        function updateHabitStatus(instanceKey, completed) {
            const data = getData(selectedDate);
            if (!data[instanceKey]) {
                data[instanceKey] = { completed: false };
            }
            data[instanceKey].completed = completed;
            setData(selectedDate, data);

            renderCalendar();
            renderDailySchedule();
            updateTodayOverview();
        }

        function getData(dateStr) {
            const data = localStorage.getItem(`habit_${dateStr}`);
            return data ? JSON.parse(data) : {};
        }

        function setData(dateStr, data) {
            localStorage.setItem(`habit_${dateStr}`, JSON.stringify(data));
        }

        // Settings
        function openSettings() {
            document.getElementById('settingsPanel').classList.add('active');
            renderScheduleEditor();
        }

        function closeSettings() {
            document.getElementById('settingsPanel').classList.remove('active');
            renderCalendar();
            renderDailySchedule();
        }

        function renderScheduleEditor() {
            const day = document.getElementById('scheduleEditDay').value;
            const container = document.getElementById('scheduleEditorList');
            container.innerHTML = '';

            const schedule = scheduleByDay[day] || [];

            schedule.forEach((item, index) => {
                const editItem = document.createElement('div');
                editItem.className = 'schedule-edit-item';

                const row = document.createElement('div');
                row.className = 'schedule-edit-row';

                const timeInput = document.createElement('input');
                timeInput.type = 'text';
                timeInput.className = 'time-input';
                timeInput.value = item.time;
                timeInput.placeholder = '8:00 AM';
                timeInput.onchange = (e) => updateScheduleTime(day, index, e.target.value);

                const habitSelect = document.createElement('select');
                habitSelect.className = 'habit-select';

                habits.forEach(habit => {
                    const option = document.createElement('option');
                    option.value = habit.id;
                    option.textContent = habit.name;
                    if (habit.id === item.habitId) option.selected = true;
                    habitSelect.appendChild(option);
                });

                habitSelect.onchange = (e) => updateScheduleHabit(day, index, e.target.value);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-delete-schedule';
                deleteBtn.textContent = 'X';
                deleteBtn.onclick = () => deleteScheduleItem(day, index);

                row.appendChild(timeInput);
                row.appendChild(habitSelect);
                row.appendChild(deleteBtn);

                editItem.appendChild(row);
                container.appendChild(editItem);
            });
        }

        function updateScheduleTime(day, index, newTime) {
            scheduleByDay[day][index].time = newTime;
            saveSchedule();
        }

        function updateScheduleHabit(day, index, habitId) {
            scheduleByDay[day][index].habitId = habitId;
            saveSchedule();
        }

        function deleteScheduleItem(day, index) {
            scheduleByDay[day].splice(index, 1);
            saveSchedule();
            renderScheduleEditor();
        }

        function addNewScheduleItem() {
            const day = document.getElementById('scheduleEditDay').value;
            if (!scheduleByDay[day]) {
                scheduleByDay[day] = [];
            }
            scheduleByDay[day].push({
                time: '12:00 PM',
                habitId: habits[0]?.id || 'wakeup'
            });
            saveSchedule();
            renderScheduleEditor();
        }

        function saveSchedule() {
            localStorage.setItem('custom_schedule', JSON.stringify(scheduleByDay));
            renderDailySchedule();
            updateTodayOverview();
        }

        // Data Management
        function viewAllData() {
            const allData = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('habit_')) {
                    allData[key] = localStorage.getItem(key);
                }
            }

            document.getElementById('dataViewContent').textContent = JSON.stringify(allData, null, 2);
            document.getElementById('dataViewModal').classList.add('active');
        }

        function closeDataView() {
            document.getElementById('dataViewModal').classList.remove('active');
        }

        function exportData() {
            const allData = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('habit_')) {
                    allData[key] = localStorage.getItem(key);
                }
            }

            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `habit-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function confirmClear() {
            document.getElementById('clearModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('clearModal').classList.remove('active');
        }

        function clearAllData() {
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('habit_')) {
                    keys.push(key);
                }
            }
            keys.forEach(key => localStorage.removeItem(key));

            closeModal();
            renderCalendar();
            renderDailySchedule();
            updateTodayOverview();
            alert('All completion data cleared!');
        }
    </script>
</body>
</html>
